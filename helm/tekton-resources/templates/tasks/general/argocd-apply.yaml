apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: argocd-apply
  namespace: tekton-tasks
spec:
  params:
    - name: repoURL
      description: URL del repositorio Git
    - name: pathToApplication
      description: Ruta relativa hacia el archivo application.yaml en el repositorio clonado
    - name: argocdServer
      description: URL del servidor de Argo CD
    - name: argocdUsername
      description: Usuario para la autenticación de Argo CD
    - name: argocdPassword
      description: Contraseña para la autenticación de Argo CD
  workspaces:
    - name: output
  volumes:
    - name: ssh-key
      secret:
        secretName: github-ssh-key
  steps:
    - name: check-create-deploy
      image: docker.io/argoproj/argocd
      workingDir: $(workspaces.output.path)
      volumeMounts:
        - name: ssh-key
          mountPath: /root/.ssh
      env:
        - name: SSH_AUTH_SOCK
          value: /tmp/ssh-agent.sock
        - name: GIT_SSH_COMMAND
          value: "ssh -o StrictHostKeyChecking=no"
      script: |
        # Assumir que o agente SSH está rodando e a chave está adicionada (ou rodar `eval $(ssh-agent)` e `ssh-add`)
        # Código existente modificado para usar 'yes' para login e assumir configuração SSH
        yes | argocd login $(params.argocdServer) --username $(params.argocdUsername) --password $(params.argocdPassword) --insecure

        # Verificar se o repositório já está registrado
        if check_repo_exists; then
          echo "Repositorio $(params.repoURL) ya está registrado."
        else
          # Registrar el repositorio si no existe
          argocd repo add $(params.repoURL) --username $(params.argocdUsername) --password $(params.argocdPassword) --insecure-skip-server-verification
        fi

        # Verificar si la aplicación ya existe
        if check_app_exists; then
          echo "La aplicación example-helm-app ya está registrada."
        else
          # Crear la aplicación usando el archivo application.yaml
          argocd app create --file $(workspaces.output.path)/$(params.pathToApplication) --insecure
        fi

        # Sincronizar la aplicación para asegurar que esté actualizada
        argocd app sync example-helm-app --insecure


